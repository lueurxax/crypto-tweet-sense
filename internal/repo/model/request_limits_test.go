package model

import (
	"testing"

	jsoniter "github.com/json-iterator/go"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

const testData = `{"WindowSeconds":2592000,"requests_v2":{"data":[2054334,12,7,51,18,8,28,60,9,10,26,60,9,7,6,70,15,9,7,48,18,9,48,173,365,366,183,268,184,274,181,276,185,270,177,270,186,271,182,292,183,276,180,269,188,277,183,276,187,183,6,9,5,75,11,10,4,52,18,10,6,75,12,8,28,59,15,6,53,17,9,26,63,278,385,296,305,488,89,183,333,178,337,184,268,184,271,184,268,181,269,187,271,182,268,182,274,181,277,184,456,91,183,99,186,182,94,92,181,126,88,189,268,93,174,371,183,92,89,183,276,182,270,94,94,184,277,191,270,182,276,179,271,178,277,181,274,272,93,180,275,177,286,185,268,177,264,180,275,180,281,181,271,178,273,182,273,183,184,95,181,261,275,185,277,187,180,90,188,275,89,187,185,186,277,177,278,183,277,180,267,193,276,278,269,185,92,179,275,278,184,275,180,279,181,276,269,178,270,178,274,185,273,180,282,184,278,179,274,181,272,185,275,180,281,182,283,277,185,280,189,274,275,276,179,275,184,281,184,275,182,271,180,270,184,280,183,278,186,276,181,279,276,187,276,187,274,184,285,267,178,274,182,271,184,277,181,270,273,188,273,182,275,185,275,276,195,270,182,280,279,179,271,185,780,89,184,278,93,187,184,271,187,180,93,93,91,190,276,183,188,181,187,185,280,183,276,184,278,271,184,270,276,276,184,277,277,177,270,186,281,269,275,186,280,186,276,273,188,273,278,361,272,273,269,89,181,272,175,278,182,273,2203,554,88,92,90,104,89,92,90,187,281,181,274,189,96,184,279,429,91,173,89,90,89,101,94,92,98,92,95,90,94,90,91,94,91,92,90,92,92,88,93,89,90,91,91,93,91,87,139,91,0,92,0,153,0,151,0,153,149,0,148,0,153,151,0,152,152,0,157,0,92,0,149,0,151,0,249,0,89,0,151,0,153,0,206,150,154,90,156,154,154,253,93,152,150,94,90,90,91,209,234,88,90,91,89,90,93,92,93,91,90,93,91,87,94,90,90,94,90,89,89,94,91,94,91,94,89,154,91,153,152,92,93,91,95,156,88,149,151,153,94,88,90,92,91,92,91,89,92,94,92,95,88,90,86,95,89,93,88,96,91,93,95,154,91,153,151,90,91,92,91,151,91,144,148,153,180,90,93,90,90,89,87,90,92,87,89,87,91,92,85,94,94,91,181,91,88,94,89,89,89,89,183,89,92,89,92,90,90,93,154,149,153,154,94,91,94,90,93,89,87,95,91,94,92,91,95,94,94,95,149,91,93,93,90,94,152,91,151,94,95,92,97,92,89,92,150,152,154,94,151,91,92,88,89,91,88,89,85,91,94,93,92,90,96,91,149,95,89,91,92,89,92,148,152,92,93,91,92,90,95,92,98,152,155,149,145,93,91,90,94,89,91,85,89,94,91,91,90,95,90,89,91,151,85,179,89,89,90,92,155,88,96,92,95,92,87,93,92,151,151,148,149,93,90,92,87,95,93,93,91,90,93,91,89,89,94,91,90,151,93,150,95,90,95,95,153,90,88,90,90,94,89,94,95,145,150,91,149,156,91,91,90,88,94,90,94,91,98,89,92,92,92,90,90,150,93,151,95,92,91,90,152,92,92,89,91,96,93,92,92,304,90,95,90,152,89,90,92,96,87,92,95,90,93,93,90,92,97,95,92,86,86,151,155,88,87,91,89,92,92,93,156,89,90,95,95,153,147,152,93,153,94,92,91,90,90,88,95,93,96,91,87,178,89,89,95,92,95,94,156,94,90,96,92,89,93,92,89,96,153,89,94,93,150,157,90,149,92,92,93,94,90,91,88,94,90,95,92,151,152,91,91,91,93,90,153,91,92,92,90,92,90,154,89,94,153,92,93,91,91,155,95,146,89,92,148,90,90,96,91,92,93,93,89,89,151,92,91,90,92,95,155,91,92,89,93,95,92,94,155,92,150,97,93,89,147,148,93,91,147,89,145,95,94,96,90,92,95,87,94,92,155,91,91,95,97,89,151,91,92,96,91,90,91,89,155,86,153,93,91,90,92,149,154,95,145,91,152,90,94,90,87,92,90,94,91,92,150,96,96,96,94,93,150,93,94,89,94,92,92,96,155,93,89,89,93,87,89,150,149,95,152,94,98,151,95,91,89,97,92,92,91,90,94,152,92,95,91,247,91,90,94,92,94,95,92,90,94,89,96,90,92,93,88,89,148,95,149,94,154,88,151,92,87,90,95,90,91,91,90,149,90,91,90,91,152,145,93,93,94,91,95,94,93,96,86,91,89,90,92,93,155,93,150,87,152,91,157,89,93,89,92,94,92,93,109,105,105,102,100,103,153,162,95,92,94,87,96,100,90,92,91,93,90,91,91,89,159,96,93,89,144,101,152,91,93,94,105,428,56,4,62,37,103,67,34,158,163,84,33,56,373,4,3,1,3,757,1,3,3,3,2,3,2,4,1514,3,1,2,3,2,3,3,3,4,2,1494,3,3,3,3,3,3,3,4,2,3,2,14,3,3,2,3,3,1496,3,3,4,4,3,3,2,2,1500,2,4,1,4,2,4,2,4,2,1514,3,2,4,3,3,3,3,1,4,3,4,2,3,2,3,3,3,3,1493,3,3,3,3,3,3,2,3,1510,3,4,2,3,3,1,4,3,3,1496,3,2,3,3,3,3,3,2,4,3,3,3,2,3,3,2,4,3,745,3,3,4,1,4,3,4,1498,3,1,3,3,3,4,3,3,3,3,1500,3,3,3,2,2,3,3,4,3,3,3,2,3,1,4,3,2,3,757,3,2,3,3,3,3,3,1509,3,2,4,4,2,3,2,3,3,1511,3,3,3,3,3,3,3,3,2,3,3,3,2,4,4,3,2,3,748,2,4,2,4,3,3,1,2,1495,2,3,2,3,1,3,2,4,2,1874,2,5,3,3,4,2,3,4,1,3,2,3,2,2,4,3,3,4,1493,3,3,2,3,2,3,2,743,3,2,4,3,1,3,3,2,2,3,758,749,3,3,2,3,3,3,3,2,3,3,3,2,3,3,3,4,2,1500,3,3,3,3,3,3,760,3,4,3,4,3,3,1,4,2,3,758,745,4,3,1,3,3,3,2,4,2,4,2,3,3,3,2,11,4,741,754,3,3,3,2,3,3,1504,4,2,3,2,3,3,4,2,4,4,3,1493,3,3,3,3,2,3,3,3,2,4,1,3,3,2,4,2,3,757,1,4,3,3,3,3,3,1512,2,2,3,3,2,3,3,3,3,2,2,1504,2,2,2,3,2,3,4,1,3,2,2,4,3,3,2,3,1501,3,3,3,2,3,3,3,3,1505,3,2,4,1,3,4,3,3,3,4,2,1502,3,1,3,3,3,2,3,3,3,3,4,2,3,2,4,2,1483,4,3,3,2,3,4,3,3,1513,3,2,3,9,3,3,4,3,3,3,754,3,4,3,3,2,4,4,3,3,1,3,4,4,3,2,2,739,755,3,3,3,2,3,3,3,3,1498,2,3,2,4,3,3,4,3,1,1488,3,2,3,3,3,4,2,3,3,1,3,3,3,3,3,2,1,762,3,3,4,1,3,3,4,2,2,1493,3,2,3,3,2,3,4,3,1518,3,4,3,1,3,2,3,3,3,3,3,3,3,3,3,2,3,770,4,3,2,3,3,3,3,3,4,1503,1,4,3,4,3,3,3,2,1,1507,2,4,3,3,3,2,3,3,3,2,3,3,3,3,3,3,754,1,3,3,3,3,3,1,4,3,1514,3,1,3,4,3,2,4,3,4,1503,3,3,3,3,3,3,3,3,2,3,4,3,2,3,4,2,3,756,3,3,3,3,2,3,1,4,3,1500,2,2,3,3,4,2,1,3,3,1509,2,2,2,3,4,1,3,4,2,3,1,3,2,4,3,3,4,1486,3,2,3,3,3,1,2,3,3,1503,3,3,3,1,3,4,3,3,2,1483,3,3,3,1,4,3,4,3,3,3,3,3,3,3,1,3,3,1508,3,2,2,4,4,2,2,3,2,1515,3,2,5,1,3,3,3,3,4,1495,3,4,3,4,2,2,3,3,3,3,3,2,3,2,3,2,1501,3,1,3,4,2,3,3,3,3,4,759,3,3,2,4,3,4,3,2,1492,3,1,4,2,4,3,2,3,4,3,2,3,2,3,3,3,750,751,3,2,3,2,3,1,3,3,3,736,1,4,3,3,3,3,4,3,3,756,764,4,3,3,4,2,3,3,3,3,4,3,1,8,2,3,1497,2,3,4,3,3,4,3,3,3,2,1510,3,3,3,3,4,4,2,4,4,2,1508,4,3,2,4,5,3,2,3,6,2,3,3,3,3,3,1512,4,5,3,3,3,6,3,3,2,4,1511,4,4,3,2,3,3,3,4,3,750,3,3,5,2,4,5,3,4,4,5,2,4,3,3,3,3,769,768,5,2,5,3,3,3,2,6,3,752,754,3,3,2,3,3,4,3,3,1507,3,1,3,4,3,3,4,1,3,3,3,3,3,3,2,4,2,1505,1,4,3,3,3,3,4,4,4,2,1495,4,3,3,4,2,4,3,1,1504,3,3,3,3,2,3,2,4,4,3,3,3,3,4,2,3,1501,4,3,3,4,3,4,3,2,3,3,3,739,3,2,3,3,3,1,4,3,1502,3,3,4,3,1,2,3,3,3,3,4,2,4,3,2,1505,4,3,4,4,2,3,3,3,3,1,3,1493,3,3,1,3,3,3,3,4,2,1495,4,1,4,2,4,3,4,3,3,2,3,3,2,3,4,1508,3,3,2,3,3,3,1,3,2,3,3,1485,3,3,3,4,2,3,2,3,3,1531,1,3,2,3,3,3,4,3,3,3,3,3,4,2,1510,3,3,3,2,2,4,3,3,2,4,4,3,1487,3,4,3,1,4,3,1,3,4,1518,2,2,3,2,4,3,4,2,2,3,2,2,2,3,757,3,3,3,2,3,4,2,3,3,3,3,4,1518,3,1,3,3,2,4,3,1,1507,4,1,2,4,4,3,3,3,3,3,3,3,4,2,746,3,3,2,4,2,2,3,3,3,3,2,3,1505,3,2,3,3,3,3,3,3,4,3,3,3,1,3,3,2,4,3,2,2,4,3,3,3,3,3,3,3,1,2,3,3,3,2,4,3,2,2,3,3,115,116,116,111,116,6,5,4,4,866,803,197,2,4,3,3,4,1802,2,3,3,3,3,3,1811,3,4,4,2,2,3,909,2,3,2,3,3,4,2,3,2,3,3,1,3,3,702,3,4,3,3,3,2,3,3,2,2,3,2,4,3,692,2,3,3,3,2,2,2,3,3,3,3,4,3,3,691,395,3,3,3,3,4,3,3,1,1637,2,3,3,3,3,3,4,2,4,1598,3,2,3,3,1,2,3,4,3,2,3,2,3,4,686,2,3,2,3,3,3,4,3,4,3,3,3,808,803,2,2,3,4,2,3,3,1605,5,1,3,3,3,3,4,3,2,3,4,1,4,3,689,4,2,4,4,2,3,3,3,4,3,4,1,1604,3,2,3,3,2,3,3,3,4,1628,3,3,3,4,3,3,3,3,2,2,3,3,3,3,691,3,4,3,3,3,3,3,2,4,3,4,1600,2,3,3,3,3,2,3,3,3,1619,3,2,3,3,4,3,2,2,4,2,2,2,3,3,707,3,3,3,3,2,5,2,3,3,1,3,3,820,3,1,3,3,3,2,4,3,3,1612,3,3,2,3,3,2,2,3,3,3,4,1,3,4,345,351,5,1607,3,2,2,4,2,2,3,2,3,1616,3,2,4,3,2,3,4,4,1,1614,3,4,2,3,11,3,3,3,4,2,4,3,2,3,693,3,2,3,3,2,3,1,3,3,3,3,3,807,817,4,3,3,3,2,2,3,3,1603,2,3,3,2,3,1,4,3,3,3,3,3,3,2,703,2,1608,3,3,3,3,2,3,3,3,3,3,4,3,3,3,689,3,3,3,2,1620,3,2,3,3,3,3,3,3,3,2,4,3,2,2,689,3,3,3,2,3,2,3,12,2,2,3,3,3,3,343,349,3,3,2,3,4,2,1612,3,3,2,4,3,2,2,3,3,3,3,4,3,2,347,344,811,4,2,4,1,4,3,3,3,3,1,1623,3,2,2,4,2,3,4,2,4,1,1621,4,2,1,3,2,3,2,3,4,2,2,2,4,4,700,2,4,3,3,4,3,3,2,3,3,2,1611,3,1,3,4,3,2,3,3,3,1599,3,2,3,3,2,2,3,3,3,4,2,3,3,3,685,3,3,3,3,3,3,3,3,2,3,4,4,1609,3,3,4,2,4,1,3,3,3,1602,3,3,3,1,3,4,2,3,3,3,3,3,4,3,697,4,3,800,3,3,3,3,2,4,3,1,3,3,1427,35,8,13,35,31,6,88,56,807,808,3,1,4,3,2,2,4,4,2,4,3,1,3,3,697,808,3,3,2,3,3,2,3,2,3,3,3,3,2,346,343,2,3,3,2,3,815,811,3,2,3,3,3,3,3,3,3,3,3,3,3,346,346,796,2,3,3,3,3,2,3,3,6,3,808,16,6,4,4,4,3,2,4,3,1602,4,2,3,3,2,3,3,3,3,3,3,3,3,347,347,800,3,4,4,3,4,2,3,3,3,3,3,798,802,2,3,3,3,2,2,3,3,811,817,1,3,3,3,3,3,2,2,3,3,3,2,3,1595,4,3,3,3,3,3,3,2,3,4,1,3,1605,4,3,2,1,4,2,3,3,4,1612,3,3,2,3,3,3,3,3,3,4,3,3,3,4,339,343,2,2,3,3,3,4,1,3,4,2,3,1616,3,2,4,3,3,4,3,3,812,8,3,4,8,3,4,2,3,3,2,3,3,3,3,346,346,26,5,4,2,3,3,2,4,3,2,3,1610,3,3,2,3,3,4,3,2,3,3,3,4,4,1,340,354,3,2,3,3,2,3,4,2,3,3,3,4,3,701,3,3,3,4,2,4,3,3,3,3,2,3,4,2,701,2,2,1,4,2,3,1608,4,2,3,3,1,817,3,3,3,3,3,3,1606,3,3,3,2,3,3,1611,3,3,3,1,3,2,3,4,1,3,3,3,4,1,698,3,3,3,3,2,3,2,3,3,5,2,3,3,3,356,344,4,3,3,4,3,5,2,3,4,3,3,3,3,351,346,4,3,3,3,3,11,2,3,1613,3,1,5,1,3,3,3,4,3,1585,2,3,3,3,2,4,2,3,1,3,4,2,3,355,346,4,2,3,2,2,3,3,3,3,3,2,4,1590,2,4,3,3,2,3,3,3,1620,4,3,3,3,3,3,1,4,3,3,4,2,3,354,349,3,3,3,3,3,3,3,3,3,3,3,4,1599,3,3,3,2,3,2,2,3,3,1607,4,3,3,3,2,4,3,2,3,3,4,3,3,2,707,3,4,3,3,3,2,3,3,2,3,4,1600,3,2,3,2,4,2,3,3,4,1612,3,3,3,4,3,3,2,2,2,3,2,4,3,352,349,3,3,3,1,3,2,3,3,3,3,4,3,1612,3,2,3,3,4,2,4,3,2,1616,1,4,3,4,3,1,3,3,3,2,3,4,2,3,345,349,3,1620,3,4,3,3,3,2,3,2,2,1604,3,3,1,3,3,3,2,3,2,1610,3,3,3,3,3,3,3,3,2,2,4,3,2,3,732,3,2,3,4,3,2,4,1,4,4,3,3,2,1601,2,3,1,4,2,3,3,2,799,1,3,4,3,3,4,3,4,3,3,3,3,3,3,690,4,1627,3,2,3,2,3,4,2,3,3,3,2,4,2,704,3,3,4,3,2,1606,3,3,3,3,4,3,3,5,3,3,3,3,2,2,684,3,3,4,2,3,2,3,3,3,3,4,1,3,2,691,2,4,3,1,3,4,2,1600,3,4,3,2,4,3,3,2,3,2,4,3,4,2,683,4,800,3,2,4,3,3,4,2,3,3,3,1607,3,3,2,4,4,3,1,2,3,3,1608,3,3,3,4,2,4,1,3,3,3,3,3,12,3,339,346,3,4,2,3,2,3,3,3,3,3,1603,3,3,3,3,2,4,2,3,2,1599,4,3,3,2,3,2,3,3,3,3,4,3,2,2,345,350,3,3,2,4,3,3,3,3,3,4,3,1624,3,4,3,2,3,2,4,2,2,1599,3,3,3,3,2,4,3,3,2,3,3,3,2,3,343,338,3,1602,3,2,3,4,3,2,4,3,3,3,4,2,4,1,690,2,3,3,3,1610,3,3,3,4,2,13,2,3,4,3,2,3,3,3,686,4,805,1,4,3,3,2,4,2,3,3,3,3,2,3,2,685,2,3,2,2,3,1602,3,2,3,4,3,1,5,3,3,3,3,2,3,3,692,3,1605,3,3,4,3,3,2,4,3,3,1,3,3,3,3,684,4,3,3,3,3,1616,2,4,3,1,3,3,3,4,3,3,3,3,3,2,694,3,3,3,1,3,4,4,4,2,3,3,3,1619,3,95,2,3,4,3,2,4,3,1597,3,2,3,3,2,3,3,4,3,3,2,3,3,2,345,355,798,2,3,3,2,3,1,3,4,3,3,1616,3,3,3,3,2,2,3,3,3,1631,3,2,3,4,3,3,2,3,3,3,2,3,3,3,698,4,3,3,2,3,2,3,3,3,3,2,2,1611,3,2,3,2,3,3,2,3,1597,3,2,3,1,3,3,2,3,3,3,2,3,2,2,700,5,2,3,2,4,2,3,2,4,3,3,3,811,4,2,4,2,2,3,3,3,3,3,3,3,3,345,351,3,3,3,3,3,2,3,3,2,4,3,2,2,695,3,3,4,2,2,2,4,3,3,3,3,3,1,3,694,4,3,2,1,3,6,3,1623,3,4,3,3,3,1598,3,3,3,3,3,2,1604,2,3,2,3,3,3,3,785,3,1,3,3,3,3,4,2,1,4,4,3,3,348,349,3,4,1,2,3,2,3,3,3,3,3,3,3,694,3,2,3,4,1,4,2,3,2,4,2,3,3,585,13,6,4,4,3,4,3,2,4,12,66,52,34,147,76,90,86,14,14,17,16,36,29,34,31,31,32,31,34,15,59,54,27,64,65,25,23,31,32,32,31,34,15,16,74,15,19,54,40,33,37,96,86,35,384,33,33,34,65,31,30,34,30,34,33,34,12,13,16,168,38,32,18,14,130,31,32,14,13,15,11,33,37,33,34,141,15,16,48,15,111,62,32,33,33,33,33,32,16,15,49,77,16,49,13,25,119,68,40,24,31,33,30,32,32,34,60,31,33,16,24,111,32,80,38,23,14,47,24,31,54,45,43,31,33,15,101,43,62,39,20,21,72,33,93,34,30,33,32,33,34,16,57,16,80,32,32,37,30,44,90,20,68,33,16,44,33,14,24,18,89,31,59,32,51,21,66,33,59,34,30,34,35,15,18,17,77,14,62,36,71,35,40,32,83,37,16,20,8,42,2,67,49,18,81,33,44,46,91,36,14,45,60,34,30,15,14,19,48,15,73,42,48,20,96,115,14,204,34,34,33,14,25,13,15,17,13,15,14,15,31,107,24,227,14,16,65,32,32,14,16,16,12,32,34,14,28,31,33,14,73,136,32,32,30,33,32,15,14,15,14,16,39,35,34,43,32,45,17,130,44,17,63,36,65,33,12,17,13,29,34,15,13,31,54,30,98,43,24,73,17,62,34,30,15,14,14,17,14,28,30,34,26,126,36,27,45,32,65,25,56,20,33,30,31,31,32,94,31,50,25,35,31,34,41,16,12,62,33,33,36,16,26,122,32,32,41,31,55,65,34,14,13,15,37,32,33,27,16,33,130,34,61,31,35,31,32,41,16,14,15,15,33,31,60,36,57,65,33,39,47,15,33,45,19,59,31,15,12,26,35,14,34,33,82,45,26,32,75,15,14,33,35,45,41,34,31,24,15,30,48,15,86,31,32,13,87,14,15,18,45,43,23,67,31,35,25,14,15,16,90,34,16,134,31,34,39,50,39,34,146,34,58,15,17,13,28,33,33,15,14,29,114,39,31,36,493,34,45,13,29,48,30,76,90,90,75,33,69,36,137,34,30,36,33,32,32,33,32,13,15,15,14,46,14,15,65,99,77,16,45,39,32,16,49,16,28,37,31,33,33,33,75,69,94,54,43,132,132,105,34,71,33,32,35,53,34,30,209,33,33,33,33,36,28,74,36,96,74,35,146,82,262,31,32,33,32,33,35,32,35,31,36,33,62,42,35,40,89,33,11,29,34,26,15,16,14,16,77,33,48,15,13,66,33,14,40,93,35,14,45,35,13,39,33,60,14,28,28,32,14,17,29,30,34,34,35,42,30,36,34,33,20,35,32,51,17,24,42,29,34,33,32,13,15,17,40,47,47,15,28,41,22,47,35,38,46,13,28,32,24,31,36,13,16,16,31,44,67,33,32,34,15,16,28,42,55,34,35,32,35,31,42,33,35,22,16,14,61,31,36,33,17,13,14,38,49,49,33,53,15,14,41,21,46,41,14,16,26,35,44,48,17,15,13,14,14,45,59,36,31,23,15,32,33,31,71,38,12,12,27,48,47,13,16,14,16,15,17,86,32,33,34,14,29,16,27,91,33,35,34,36,32,14,15,29,32,13,28,33,18,23,28,39,17,12,16,15,54,53,36,38,24,32,33,29,36,33,32,16,13,30,33,15,27,35,12,28,35,12,30,45,39,26,36,36,31,32,21,34,39,13,15,20,60,32,32,34,14,16,14,13,28,47,37,17,36,47,13,34,36,34,32,32,15,25,41,28,34,34,36,15,13,16,16,15,52,17,16,63,30,35,37,31,33,20,16,15,45,16,16,32,33,34,13,16,15,14,30,31,34,15,15,66,34,34,38,34,33,33,14,15,14,13,30,34,14,26,13,16,13,16,47,37,38,33,47,15,28,40,45,22,34,14,14,16,15,20,37,34,17,16,16,14,13,15,35,35,31,34,15,21,17,32,32,31,13,16,16,30,15,14,17,14,24,34,32,34,33,17,15,14,13,30,34,35,13,16,15,15,15,17,34,47,13,15,22,21,31,31,33,34,64,33,14,43,32,6,16,8,8,17,9,10,8,16,10,10,9,14,8,9,15,10,9,9,15,9,9,16,31,35,31,31,34,33,9,17,8,9,16,8,10,6,17,8,9,16,33,33,31,34,29,33,9,17,8,9,9,17,10,8,16,7,8,8,14,11,91,22,6,9,236,26,9,10,9,15,9,8,19,7,17,10,9,17,8,9,10,18,9,8,17,10,7,10,15,8,9,18,7,17,9,10,16,9,6,8,68,9,16,8,9,16,8,24,26,45,12,10,28,13,9,15,9,10,673,31,32,33,61,30,34,367,67,34,31,36,95,33,147,181,87,36,43,93,32,141,185,88,35,32,48,60,32,96,31,46,61,32,32,77,73,33,34,63,29,31,32,32,33,65,32,80,64,34,58,33,33,34,29,33,61,31,32,32,30,34,34,62,33,32,34,29,32,61,32,32,33,33,34,97,34,33,35,62,32,32,33,33,33,60,32,33,33,33,36,61,36,31,36,32,33,66,31,34,34,31,62,33,33,33,33,37,61,32,67,34,31,35,34,32,36,34,32,33,35,32,35,34,33,36,32,32,35,33,33,33,34,34,34,33,34,33,33,33,30,31,35,34,32,32,32,34,31,33,34,32,31,33,32,31,32,33,31,33,32,32,31,33,32,36,34,33,35,35,33,32,34,32,31,35,31,32,36,32,36,30,34,34,34,32,33,32,35,35,34,37,33,31,31],"start":"2023-11-09T12:08:15.750938853Z"},"Threshold":172800}` //nolint:lll

func TestRequestLimits_Marshal(t *testing.T) {
	testStruct := new(RequestLimits)

	require.NoError(t, jsoniter.UnmarshalFromString(testData, testStruct))

	t.Run("marshal-unmarshal", func(t *testing.T) {
		got, err := testStruct.Marshal()
		require.NoError(t, err)

		got2 := new(RequestLimits)
		require.NoError(t, got2.Unmarshal(got))

		assert.EqualValues(t, testStruct, got2)
	})
}

func TestRequestLimits_ToV2(t *testing.T) {
	testStruct := new(RequestLimits)

	require.NoError(t, jsoniter.UnmarshalFromString(testData, testStruct))

	t.Run("real data", func(t *testing.T) {
		data := testStruct.ToV2()

		assert.Equal(t, len(testStruct.Requests.Data), int(data.RequestsCount))
		assert.Equal(t, len(testStruct.Requests.Data)/maxRequestsInBatch+1, len(data.Requests))
	})
}

func TestRequestLimits_CleanCounters(t *testing.T) {
	testStruct := new(RequestLimits)

	require.NoError(t, jsoniter.UnmarshalFromString(testData, testStruct))
	t.Run("empty", func(t *testing.T) {
		got := testStruct.CleanCounters()
		assert.Equalf(t, len(testStruct.Requests.Data), len(got.Data), "CleanCounters()")
		diff := got.Start.Sub(testStruct.Requests.Start).Seconds()
		assert.Equal(t, int32(float64(testStruct.Requests.Data[0])-diff), got.Data[0])
		for i := range testStruct.Requests.Data[1:len(testStruct.Requests.Data)] {
			assert.Equalf(t, testStruct.Requests.Data[i+1], got.Data[i+1], "different elements %d", i)
		}
	})
}
